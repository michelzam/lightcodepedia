name: Check Streamlit Status

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

jobs:
  status:
    runs-on: ubuntu-latest
    steps:
      - name: Check app
        run: |
          URL="https://lightcodepedia1.streamlit.app"
          STATUS=$(curl -L -o /dev/null -s -w "%{http_code}" --max-time 30 "$URL")
          if [ $? -ne 0 ]; then
            STATUS=503
          fi
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "{\"url\":\"$URL\",\"status\":$STATUS,\"timestamp\":\"$TS\"}" > status.json

      - name: Update gist
        env:
          GH_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          CONTENT=$(cat status.json | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
      
          curl -s -X PATCH \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/gists/44a30e5475ac6a6bf2272556836aa858 \
            -d "{
              \"files\": {
                \"status.json\": {
                  \"content\": $CONTENT
                }
              }
            }"
